# ============================================================================
# Valida√ß√£o de Pull Requests - Conventional Commits + Quality Checks
# ============================================================================
name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Validar T√≠tulo do PR (Conventional Commits)
  # ============================================================================
  validate-title:
    name: Validar T√≠tulo do PR
    runs-on: ubuntu-latest
    steps:
      - name: Verificar t√≠tulo do PR
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
          requireScope: false

  # ============================================================================
  # Detectar Breaking Changes
  # ============================================================================
  breaking-changes:
    name: Detectar Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar indicador de breaking changes
        id: breaking
        run: |
          if git log --format=%B -n 1 ${{ github.event.pull_request.head.sha }} | grep -q "BREAKING CHANGE"; then
            echo "has_breaking=true" >> $GITHUB_OUTPUT
          else
            echo "has_breaking=false" >> $GITHUB_OUTPUT
          fi

      - name: Comentar no PR se breaking changes detectadas
        if: steps.breaking.outputs.has_breaking == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ‚ö†Ô∏è Breaking Changes Detectadas

            Este PR cont√©m mudan√ßas que quebram compatibilidade. Por favor, certifique-se de:
            - [ ] CHANGELOG.md foi atualizado
            - [ ] Guia de migra√ß√£o fornecido (se necess√°rio)
            - [ ] Documenta√ß√£o foi atualizada
            - [ ] Version bump ser√° MAJOR (semver)

  # ============================================================================
  # Label de Tamanho do PR
  # ============================================================================
  size-label:
    name: Label de Tamanho
    runs-on: ubuntu-latest
    steps:
      - name: Adicionar label de tamanho
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false

  # ============================================================================
  # Verificar TODO/FIXME
  # ============================================================================
  check-todos:
    name: Verificar TODO/FIXME
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Procurar novos TODO/FIXME
        run: |
          if git diff origin/${{ github.base_ref }}..HEAD | grep -E '^\+.*TODO|FIXME'; then
            echo "::warning::Novos coment√°rios TODO ou FIXME encontrados neste PR"
            echo "Considere criar issues para estes itens"
          fi
        continue-on-error: true

  # ============================================================================
  # Sugerir Revisores
  # ============================================================================
  suggest-reviewers:
    name: Sugerir Revisores
    runs-on: ubuntu-latest
    steps:
      - name: Auto-assign reviewers
        uses: kentaro-m/auto-assign-action@v1.2.5
        with:
          configuration-path: '.github/auto-assign.yml'
        continue-on-error: true

  # ============================================================================
  # Verificar Documenta√ß√£o
  # ============================================================================
  check-docs:
    name: Verificar Documenta√ß√£o
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-docs-

      - name: Verificar documenta√ß√£o
        run: cargo doc --no-deps --all-features --workspace
        env:
          RUSTDOCFLAGS: "-D warnings"

  # ============================================================================
  # Resumo da Valida√ß√£o
  # ============================================================================
  pr-summary:
    name: Resumo da Valida√ß√£o
    runs-on: ubuntu-latest
    needs: [validate-title, check-docs]
    if: always()
    steps:
      - name: Criar coment√°rio de resumo
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üìã Resumo da Valida√ß√£o do PR

            ‚úÖ **Valida√ß√µes autom√°ticas conclu√≠das!**

            ### Pr√≥ximos Passos:
            - Aguardar verifica√ß√µes de CI completarem
            - Endere√ßar coment√°rios de revis√£o
            - Garantir que todos os testes passem
            - Obter aprova√ß√£o dos mantenedores

            ### Checklist para Merge:
            - [ ] Todos os checks de CI passaram
            - [ ] C√≥digo revisado e aprovado
            - [ ] Documenta√ß√£o atualizada
            - [ ] CHANGELOG.md atualizado (se necess√°rio)
            - [ ] Testes adicionados/atualizados

            ---
            *Este coment√°rio ser√° atualizado conforme as verifica√ß√µes completam*
        continue-on-error: true
