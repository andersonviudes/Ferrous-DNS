FROM alpine:3.19

ARG TARGETARCH

RUN apk add --no-cache \
    ca-certificates \
    tzdata && \
    addgroup -g 1000 ferrous && \
    adduser -D -u 1000 -G ferrous -s /bin/sh ferrous && \
    mkdir -p /data/config /data/db /data/logs && \
    chown -R ferrous:ferrous /data

COPY dist/ferrous-dns-linux-${TARGETARCH} /usr/local/bin/ferrous-dns
COPY --chown=ferrous:ferrous ferrous-dns.toml /usr/local/share/ferrous-dns/ferrous-dns.toml
COPY --chown=ferrous:ferrous migrations/ /usr/local/share/ferrous-dns/migrations/
COPY docker/entrypoint.sh /entrypoint.sh

RUN chmod +x /entrypoint.sh && \
    chown root:root /usr/local/bin/ferrous-dns && \
    chmod 755 /usr/local/bin/ferrous-dns

WORKDIR /data
USER ferrous

HEALTHCHECK --interval=5s --timeout=3s --start-period=5s --retries=60 \
    CMD /usr/local/bin/ferrous-dns --version || exit 1

ENV FERROUS_CONFIG="/data/config/ferrous-dns.toml" \
    FERROUS_DNS_PORT="53" \
    FERROUS_WEB_PORT="8080" \
    FERROUS_BIND_ADDRESS="0.0.0.0" \
    FERROUS_DATABASE="/data/db/ferrous.db" \
    FERROUS_LOG_LEVEL="info" \
    RUST_LOG="info"

VOLUME ["/data"]

ENTRYPOINT ["/entrypoint.sh"]
